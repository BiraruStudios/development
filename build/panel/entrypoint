#!/usr/bin/env bash
set -x
set -e
set -o pipefail

# Environment variables
PHP_VERSION=8.3

# Update pterodactyl user UID if WWWUSER is set
if [ -n "$WWWUSER" ]; then
  usermod -u "$WWWUSER" pterodactyl
fi

# Enable all available PHP modules for CLI and FPM
if [ -d "/etc/php/mods-available" ]; then
  # Link CLI mods
  if [ -d "/etc/php/mods-available/cli" ]; then
    ln -sf /etc/php/mods-available/cli/* /etc/php/$PHP_VERSION/cli/conf.d
  fi

  # Link FPM mods
  if [ -d "/etc/php/mods-available/fpm" ]; then
    ln -sf /etc/php/mods-available/fpm/* /etc/php/$PHP_VERSION/fpm/conf.d
  fi

  # Link all available mods to both CLI and FPM
  find /etc/php/mods-available/. -maxdepth 1 -type f -print0 | while read -d $'\0' file; do
    ln -sf "$file" /etc/php/$PHP_VERSION/cli/conf.d/
    ln -sf "$file" /etc/php/$PHP_VERSION/fpm/conf.d/
  done
fi

# Install custom certificates if provided
if [ -d "/etc/certs" ]; then
  mkdir -p /usr/local/share/ca-certificates/mkcert
  cp /etc/certs/pterodactyl*.pem /usr/local/share/ca-certificates/mkcert/
  update-ca-certificates
fi

# Set working directory
cd /var/www/html || exit 1

# Set permissions for Laravel directories
chown -R pterodactyl:www-data storage bootstrap/cache
chmod -R 775 storage bootstrap/cache

# Start shell or services
if [ $# -gt 0 ]; then
  sudo su -l pterodactyl -c "/bin/bash"
else
  service cron start
  /usr/bin/supervisord -c /etc/supervisord.conf -n
fi
