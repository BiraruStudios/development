#!/usr/bin/env bash

# Set working directory
cd /var/www/html || exit 1

# Copy env file
if [ ! -f ".env" ]; then
  cp .env.example .env
fi

# Add app variables to env
sed -i "s/APP_ENV=.*/APP_ENV=local/" .env
sed -i "s/APP_DEBUG=.*/APP_DEBUG=true/" .env

# Install Composer
COMPOSER_ALLOW_SUPERUSER=1 composer install --no-interaction --prefer-dist --no-scripts --no-progress

# Generate a key if it doesn't already exist
if ! grep -q '^APP_KEY=' .env || grep -q '^APP_KEY=$' .env; then
    php artisan key:generate --force
fi

# Install project dependencies
yarn install --no-progress

# Build
yarn run build

# Allow HMR (Hot Module Reloading) by serving
nohup yarn run serve > /var/log/yarn-serve.log 2>&1 &

# Restart cron, nginx, and PHP-FPM
sudo service cron restart
sudo supervisorctl restart nginx
sudo supervisorctl restart php-fpm
